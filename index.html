<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Damas Pro - Fix Pe√ßas</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --board-dark: #769656;
            --board-light: #eeeed2;
            --white-p: radial-gradient(circle, #ffffff 30%, #f0f0f0 100%);
            --black-p: radial-gradient(circle, #444444 30%, #000000 100%);
            --accent: #2ecc71;
            --warning: #f1c40f;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: none; 
            user-select: none;
        }

        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #top-bar { background: #111; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        #game-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #222; }
        #board-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; position: relative; }
        
        #board { 
            width: min(90vw, 450px); 
            height: min(90vw, 450px); 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            grid-template-rows: repeat(8, 1fr); 
            border: 5px solid #333;
        }

        .square { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; }
        .dark-sq { background-color: var(--board-dark); }
        .light-sq { background-color: var(--board-light); }

        .piece { 
            position: absolute; 
            width: 85%; 
            height: 85%; 
            border-radius: 50%; 
            z-index: 10; 
            pointer-events: none; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            border: 2px solid rgba(0,0,0,0.2);
        }
        .white { background: var(--white-p); }
        .black { background: var(--black-p); }
        .king::after { content: 'üëë'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; }
        
        .selected-sq { background-color: rgba(241, 196, 15, 0.7) !important; }
        .hint { position: absolute; width: 30%; height: 30%; background: rgba(0, 255, 0, 0.6); border-radius: 50%; z-index: 15; pointer-events: none; }

        .timer { font-family: monospace; font-size: 1.5rem; background: #000; padding: 5px; text-align: center; border-radius: 4px; color: #444; border: 2px solid #333; }
        .timer.active { color: var(--accent); border-color: var(--accent); }
        #status-bar { grid-column: span 2; text-align: center; color: var(--warning); font-weight: bold; font-size: 0.9rem; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div style="font-weight: bold; color: var(--accent);">üëë DAMAS PRO</div>
        <div id="status-online" style="font-size: 12px; color: #aaa;">Conectado</div>
    </div>

    <div id="game-info">
        <div><div id="timer-black" class="timer">05:00</div></div>
        <div><div id="timer-white" class="timer active">05:00</div></div>
        <div id="status-bar">Sincronizando...</div>
    </div>

    <div id="board-wrapper">
        <div id="board"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCYv_oBSjS7x7hLx8p1IANOWMI5G6OmpGo",
      authDomain: "damas-pro-cf92b.firebaseapp.com",
      databaseURL: "https://damas-pro-cf92b-default-rtdb.firebaseio.com",
      projectId: "damas-pro-cf92b",
      storageBucket: "damas-pro-cf92b.firebasestorage.app",
      messagingSenderId: "606989896803",
      appId: "1:606989896803:web:63c2b940baf9f82fcf7c56"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'partida/atual');

    let board = [];
    let turn = 'white';
    let selectedSq = null;
    let legalMoves = [];
    let timers = { white: 300, black: 300 };

    // FUN√á√ÉO PARA CRIAR O TABULEIRO INICIAL
    function createInitialBoard() {
        let newBoard = [];
        for (let r = 0; r < 8; r++) {
            newBoard[r] = [];
            for (let c = 0; c < 8; c++) {
                if ((r + c) % 2 === 0) {
                    if (r < 3) newBoard[r][c] = { color: 'black', king: false };
                    else if (r > 4) newBoard[r][c] = { color: 'white', king: false };
                    else newBoard[r][c] = null;
                } else {
                    newBoard[r][c] = null;
                }
            }
        }
        return newBoard;
    }

    // DESENHA O TABULEIRO F√çSICO (HTML)
    window.renderBoardStructure = function() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const sq = document.createElement('div');
                sq.className = `square ${(r+c)%2===0?'dark-sq':'light-sq'}`;
                sq.id = `sq-${r}-${c}`;
                sq.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    handleInteraction(r, c);
                });
                boardEl.appendChild(sq);
            }
        }
    };

    function handleInteraction(r, c) {
        const p = board[r][c];
        if (p && p.color === turn) {
            selectedSq = { r, c };
        } else if (selectedSq) {
            const move = legalMoves.find(m => m.fr === selectedSq.r && m.fc === selectedSq.c && m.tr === r && m.tc === c);
            if (move) {
                executeMove(move);
            } else {
                selectedSq = null;
            }
        }
        renderPieces();
    }

    function executeMove(move) {
        const p = board[move.fr][move.fc];
        board[move.tr][move.tc] = p;
        board[move.fr][move.fc] = null;
        if (move.victim) board[move.victim.r][move.victim.c] = null;
        if (!p.king && ((p.color === 'white' && move.tr === 0) || (p.color === 'black' && move.tr === 7))) p.king = true;
        
        turn = turn === 'white' ? 'black' : 'white';
        selectedSq = null;
        update(gameRef, { board, turn, timers });
    }

    onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        if (!data || !data.board) {
            // Se o Firebase estiver vazio, reinicia tudo
            board = createInitialBoard();
            set(gameRef, { board, turn: 'white', timers: {white:300, black:300} });
        } else {
            board = data.board;
            turn = data.turn;
            timers = data.timers || {white: 300, black: 300};
        }
        updateLogic();
        renderPieces();
    });

    function updateLogic() {
        let caps = [];
        let normals = [];
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const p = board[r][c];
                if (p?.color !== turn) continue;
                const dirs = [[1,1],[1,-1],[-1,1],[-1,-1]];
                dirs.forEach(d => {
                    let vr = r+d[0], vc = c+d[1], tr = r+d[0]*2, tc = c+d[1]*2;
                    if (tr>=0 && tr<8 && tc>=0 && tc<8) {
                        if (board[vr][vc] && board[vr][vc].color !== turn && !board[tr][tc]) {
                            caps.push({ fr:r, fc:c, tr, tc, victim: {r:vr, c:vc} });
                        }
                    }
                    let nr = r+d[0], nc = c+d[1];
                    if (nr>=0 && nr<8 && nc>=0 && nc<8 && !board[nr][nc]) {
                        if (p.king || (p.color==='white' && d[0]<0) || (p.color==='black' && d[0]>0)) {
                            normals.push({ fr:r, fc:c, tr:nr, tc:nc });
                        }
                    }
                });
            }
        }
        legalMoves = caps.length > 0 ? caps : normals;
    }

    function renderPieces() {
        document.getElementById('status-bar').innerText = turn === 'white' ? "VEZ DAS BRANCAS" : "VEZ DAS PRETAS";
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const sq = document.getElementById(`sq-${r}-${c}`);
                if (!sq) continue;
                sq.innerHTML = '';
                sq.classList.remove('selected-sq');
                
                const p = board[r][c];
                if (p) {
                    const div = document.createElement('div');
                    div.className = `piece ${p.color} ${p.king ? 'king' : ''}`;
                    sq.appendChild(div);
                }

                if (selectedSq?.r === r && selectedSq?.c === c) {
                    sq.classList.add('selected-sq');
                }

                if (selectedSq && legalMoves.some(m => m.fr===selectedSq.r && m.fc===selectedSq.c && m.tr===r && m.tc===c)) {
                    const h = document.createElement('div');
                    h.className = 'hint';
                    sq.appendChild(h);
                }
            }
        }
    }

    renderBoardStructure();
    
    setInterval(() => {
        if (turn === 'white') timers.white--; else timers.black--;
        const f = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        document.getElementById('timer-white').innerText = f(timers.white);
        document.getElementById('timer-black').innerText = f(timers.black);
    }, 1000);
</script>
</body>
</html>
